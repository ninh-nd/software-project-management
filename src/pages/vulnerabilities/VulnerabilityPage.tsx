import { AddOutlined } from "@mui/icons-material";
import { Box, Button, Dialog, Divider, TextField } from "@mui/material";
import {
  DataGrid,
  GridColDef,
  GridToolbarContainer,
  GridToolbarQuickFilter,
} from "@mui/x-data-grid";
import { useQuery, useQueryClient } from "@tanstack/react-query";
import * as React from "react";
import { useForm } from "react-hook-form";
import { createCVE, getCVE, getVulnerabilities } from "~/actions/vulnAction";
import AlertSnackbar from "~/components/common/AlertSnackbar";
import { IVulnerabilityCreate } from "~/interfaces/Vulnerability";
function EditToolbar({ setOpen }: { setOpen: (open: boolean) => void }) {
  const addRecord = () => {
    setOpen(true);
  };
  return (
    <GridToolbarContainer sx={{ justifyContent: "space-between" }}>
      <Button color="primary" startIcon={<AddOutlined />} onClick={addRecord}>
        Add record
      </Button>
      <GridToolbarQuickFilter />
    </GridToolbarContainer>
  );
}

function AddVulDialog({
  open,
  setOpen,
  setOpenSnackbar,
}: {
  open: boolean;
  setOpen: (open: boolean) => void;
  setOpenSnackbar: (open: boolean) => void;
}) {
  const queryClient = useQueryClient();
  const { register, handleSubmit } = useForm<{ cveId: string }>();
  const [error, setError] = React.useState(false);
  const [errorText, setErrorText] = React.useState("");
  const [cve, setCve] = React.useState<IVulnerabilityCreate>({
    cveId: "",
    description: "",
    product: "",
    version: [],
    vendor: "",
    score: 0,
    cwes: [],
  });
  const { product, version, vendor, score, cwes } = cve;
  const searchCve = async ({ cveId }: { cveId: string }) => {
    const { data } = await getCVE(cveId);
    if (data === null) {
      setError(true);
      setErrorText("CVE-ID not found");
      return;
    } else {
      setError(false);
      setErrorText("");
    }
    const {
      cveId: id,
      description,
      product,
      version,
      vendor,
      score,
      cwes,
    } = data;
    setCve({
      cveId: id,
      description,
      product,
      version,
      vendor,
      score,
      cwes,
    });
  };
  const importSingleCve = async () => {
    if (error) {
      return;
    }
    console.log(cve);
    const response = await createCVE(cve);
    if (response.status === "success") {
      queryClient.invalidateQueries(["vuln"]);
      setOpenSnackbar(true);
      setOpen(false);
    }
  };
  return (
    <Dialog open={open} onClose={() => setOpen(false)}>
      <Box sx={{ p: 2, height: "50vh", width: "20vw" }}>
        <Box
          sx={{ display: "flex", justifyContent: "space-between" }}
          component="form"
          onSubmit={handleSubmit(searchCve)}
        >
          <TextField
            margin="normal"
            required
            autoFocus
            label="CVE-ID"
            variant="standard"
            {...register("cveId")}
            error={error}
            helperText={errorText}
          />
          <Button
            variant="contained"
            color="primary"
            sx={{ mt: "16px", mb: "8px" }}
            type="submit"
          >
            Search CVE
          </Button>
        </Box>
        <Box
          sx={{
            display: "flex",
            justifyContent: "space-between",
            flexWrap: "wrap",
          }}
        >
          <TextField
            margin="normal"
            label="Product"
            variant="standard"
            disabled
            value={product}
          />
          <TextField
            margin="normal"
            label="Version"
            variant="standard"
            disabled
            value={version}
          />
          <TextField
            margin="normal"
            label="Vendor"
            variant="standard"
            disabled
            value={vendor}
          />
          <TextField
            margin="normal"
            label="Score"
            variant="standard"
            disabled
            value={score}
          />
          <TextField
            margin="normal"
            label="CWE-ID"
            variant="standard"
            disabled
            value={cwes}
          />
        </Box>
        <Box sx={{ display: "flex", justifyContent: "center" }}>
          <Button
            variant="contained"
            color="primary"
            sx={{ m: 2 }}
            onClick={importSingleCve}
          >
            Import this CVE
          </Button>
        </Box>
        <Divider>OR</Divider>
      </Box>
    </Dialog>
  );
}

export default function VulnerabilityPage() {
  const [open, setOpen] = React.useState(false);
  const [openSnackbar, setOpenSnackbar] = React.useState(false);
  const columns: GridColDef[] = [
    { field: "cveId", headerName: "CVE-ID", flex: 1 },
    { field: "product", headerName: "Product", flex: 1 },
    { field: "version", headerName: "Version", flex: 1 },
    { field: "vendor", headerName: "Vendor", flex: 1 },
    { field: "score", headerName: "Score", flex: 1 },
    {
      field: "severity",
      headerName: "Severity",
      flex: 1,
      renderCell: (params) => (
        <Box
          sx={{
            color:
              params.value === "High"
                ? "error.main"
                : params.value === "Medium"
                ? "warning.main"
                : "success.main",
          }}
        >
          {params.value}
        </Box>
      ),
    },
    { field: "cwes", headerName: "CWE-ID", flex: 1 },
  ];
  const getVulQuery = useQuery(["vuln"], getVulnerabilities);
  const vulns = getVulQuery.data === undefined ? [] : getVulQuery.data.data;
  return (
    <Box sx={{ height: 500, width: "100%" }}>
      <DataGrid
        columns={columns}
        rows={vulns}
        disableColumnFilter
        disableColumnSelector
        disableDensitySelector
        components={{
          Toolbar: EditToolbar,
        }}
        componentsProps={{
          toolbar: {
            showQuickFilter: true,
            quickFilterProps: { debounceMs: 500 },
            setOpen: setOpen,
          },
        }}
        getRowId={(row) => row.cveId}
      />
      <AddVulDialog
        open={open}
        setOpen={setOpen}
        setOpenSnackbar={setOpenSnackbar}
      />
      <AlertSnackbar
        open={openSnackbar}
        onClose={() => setOpenSnackbar(false)}
        status="success"
      />
    </Box>
  );
}
